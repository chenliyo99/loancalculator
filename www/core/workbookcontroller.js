/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.core.WorkbookController"),goog.require("idr.core.Component"),goog.require("idr.core.ViewController"),goog.require("idr.workbook.WorkbookView"),goog.require("idr.workbook.Workbook"),goog.require("idr.workbook.DefaultRange"),idr.core.WorkbookController=function(editor){this._editor=editor,this._workbook=new idr.workbook.Workbook,this._view=null,this._itemCount=0,idr.core.WorkbookController.instance=this,this._onreadyCallback=null},idr.core.WorkbookController.prototype.workbook=function(){return this._workbook},idr.core.WorkbookController.prototype.initialize=function(onreadyCallback){this._onreadyCallback=onreadyCallback,this._editor&&(this._editor.registerAction(this,new idr.core.Action("CONTENT.BOLD","Ctrl-B")),this._editor.registerAction(this,new idr.core.Action("CONTENT.ITALIC","Ctrl-I")),this._editor.registerAction(this,new idr.core.Action("CONTENT.UNDERLINE","Ctrl-U"))),this._view=new idr.workbook.WorkbookView(this)},idr.core.WorkbookController.prototype.setFocus=function(value){this._view.setFocus(value)},idr.core.WorkbookController.prototype.clean=function(callback){this._workbook.clean(),this._view.clean(callback)},idr.core.WorkbookController.prototype.receiveAction=function(actionKey){var toolbar=this._view._componentToolbar;toolbar.performToolbarActionWithKey(actionKey,this._workbook)},idr.core.WorkbookController.prototype.view=function(){return this._view.workbookView()},idr.core.WorkbookController.prototype.viewAddedToDOM=function(){this._view.initialize(this._onreadyCallback)},idr.core.WorkbookController.prototype.workbookResize=function(width,height){this._view.resize(width,height)},idr.core.WorkbookController.prototype.serializeToJson=function(){var workbookObj={};return workbookObj.model=this._workbook.toJson(),workbookObj.view=this._view.toJson(),workbookObj},idr.core.WorkbookController.prototype.loadFromJson=function(workbookJsonObj,offsetRowCol){"object"==typeof workbookJsonObj&&(this._workbook.loadFromJson(workbookJsonObj.model),this._view.updateFromJson(workbookJsonObj.view,offsetRowCol))},idr.core.WorkbookController.prototype.loadTemplate=function(templateJsonObj){var offset={row:0,column:0};return"object"==typeof templateJsonObj&&(offset=this._workbook.loadTemplate(templateJsonObj.model),this._view.updateFromJson(templateJsonObj.view,offset)),offset},idr.core.WorkbookController.prototype.getWorkbookEngine=function(){return this._view.getWorkbook()},idr.core.WorkbookController.prototype.undoHistoryRequested=function(interactionData){var data=JSON.parse(interactionData.data),dataCells=data.cells,rangeName=data.rangeName,cells=[];if("setCells"===interactionData.type){for(var i=0;i<dataCells.length;i++)cells.push({Name:dataCells[i].name,FormulaText:dataCells[i].formulaText});this._workbook.setCellsByArrayToWorksheet(data.worksheetName,cells)}"performToolbarAction"===interactionData.type&&dataCells.length>0&&this._workbook.performCellStyle(data.worksheetName,dataCells[0].action,data.selectedCells,dataCells[0].fontStyle,dataCells[0].value);var range=new idr.workbook.DefaultRange(rangeName),firstRowCol=range.getFirstRowCol(),lastRowCol=range.getLastRowCol();this._view._handsontable.selectCell(firstRowCol.row,firstRowCol.column,lastRowCol.row,lastRowCol.column)},idr.core.WorkbookController.prototype.redoHistoryRequested=function(interactionData){idr.debug.log(interactionData.toString())},idr.core.WorkbookController.prototype.setCells=function(worksheetName,data){this.pushIntoHistory(worksheetName,data,"setCells",null);var cells=[];for(var i in data){var row=data[i][0],col=data[i][1],formulaText=data[i][3];formulaText=idr.core.WorkbookController.normalizeFormulaText(formulaText);var cellName=this._workbook._runtime.rowColumnToCellName(row,col);cells.push({Name:cellName,FormulaText:formulaText})}return 0!==cells.length?this._workbook.setCellsByArrayToWorksheet(worksheetName,cells):null},idr.core.WorkbookController.prototype.performToolbarAction=function(toolbarDataItem,targetInstance,selectedItem,worksheetName,selectedCells){this._view.closeEdition(),this.pushIntoHistory(worksheetName,selectedCells,"performToolbarAction",toolbarDataItem);{var action=toolbarDataItem.action;this._workbook[action]}this._workbook[action]instanceof Function?this._workbook[action](worksheetName,selectedCells,toolbarDataItem,selectedItem):idr.debug.log('Action "'+action+'" is not defined in workbook')},idr.core.WorkbookController.prototype.pushIntoHistory=function(worksheetName,selectedCells,type,typeValues){var startRowCol,endRowCol,rangeName,cells,cellsDataArray,cellData;if("setCells"===type){startRowCol={row:selectedCells[0][0],column:selectedCells[0][1]},endRowCol={row:selectedCells[selectedCells.length-1][0],column:selectedCells[selectedCells.length-1][1]},rangeName=idr.workbook.DefaultRange.rowColumnToRangeName(startRowCol,endRowCol),cells=this._workbook.getCellsByRangeFromWorksheet(worksheetName,rangeName,!0),cellsDataArray={worksheetName:worksheetName,rangeName:rangeName,cells:[]};for(var i=0;i<cells.length;i++)cellData={name:cells[i].Name,formulaText:cells[i].FormulaText},cellsDataArray.cells.push(cellData);this._editor&&this._editor.pushIntoHistory(this,{type:type,data:JSON.stringify(cellsDataArray)})}if("performToolbarAction"===type){startRowCol={row:selectedCells[0],column:selectedCells[1]},endRowCol={row:selectedCells[2],column:selectedCells[3]},rangeName=idr.workbook.DefaultRange.rowColumnToRangeName(startRowCol,endRowCol),cells=this._workbook.getCellsByRangeFromWorksheet(worksheetName,rangeName,!0),cellsDataArray={worksheetName:worksheetName,rangeName:rangeName,selectedCells:selectedCells,cells:[]};for(var j=0;j<cells.length;j++)cellData={name:cells[j].Name,action:typeValues.action,fontStyle:typeValues.formatType,value:cells[j].CellStyle?cells[j].CellStyle.getFontStyle(typeValues.formatType):!1},cellsDataArray.cells.push(cellData);this._editor&&this._editor.pushIntoHistory(this,{type:type,data:JSON.stringify(cellsDataArray)})}},idr.core.WorkbookController.prototype.highligthFormula=function(formulaText){this._view.highligthFormula(formulaText)},idr.core.WorkbookController.prototype.unhighlightFormula=function(formulaText){this._view.unhighlightFormula(formulaText)},idr.core.WorkbookController.prototype.hookToViewEvent=function(eventName,callback){$(this._view).on(eventName,callback)},idr.core.WorkbookController.prototype.solveNameToSelector=function(mainName,subName,options){return"workbook"===mainName?this._view.solveNameToSelector(mainName,subName,options):null},idr.core.WorkbookController.prototype.listenOneTimeEvent=function(itemName,eventName,args,callback){if("workbook"===itemName){if("cell-changed"!==eventName||2!==args.length)return this._view.listenOneTimeEvent(itemName,eventName,args,callback);var that=this,cellsChangedCallback=function(event,worksheetName,cells){for(var i in cells){var cell=cells[i];cell.Name===args[0]&&cell.Value===args[1]&&(callback(),that._workbook.removeWorksheetChangedCallback(cellsChangedCallback))}};this._workbook.addWorksheetChangedCallback(cellsChangedCallback)}},idr.core.WorkbookController.prototype.getAnalytics=function(){return this._workbook.getAnalytics()},idr.core.WorkbookController.prototype.isEmpty=function(){return this._workbook.isEmpty()},idr.core.WorkbookController.prototype.baseView=function(){return this._editor.baseView()},idr.core.WorkbookController.prototype.baseOffset=function(){return this._editor.baseOffset()},idr.core.WorkbookController.normalizeFormulaText=function(value){var result=value;if("string"==typeof value&&""!==value){var regex=new RegExp("^(((-?\\d+)?\\.?(\\d+)?)|((-?\\d{1,3})(,\\d{3})*(\\.\\d+)?))$");regex.test(value)&&(result=value.replace(/,/g,""),result=parseFloat(result),isNaN(result)&&(result=value))}return result};