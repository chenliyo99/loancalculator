/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.core.Editor"),goog.require("idr.debug"),goog.require("idr.storyboard.StoryboardController"),goog.require("idr.core.WorkbookController"),goog.require("idr.workbook.WorkbookView"),goog.require("idr.core.DefaultBinder"),goog.require("idr.runtime.LivePreview"),goog.require("idr.core.ActionsController"),idr.core.Editor=function(settings){idr.core.Editor.dictionary=settings.dictionary,this._baseView=settings.baseView||$("body"),this._baseSelectors=settings.baseSelectors||[],this._workbookController=new idr.core.WorkbookController(this),this._storyboard=new idr.storyboard.StoryboardController(this),this._livePreview=new idr.runtime.LivePreview(this),this._binder=null,this._actionsController=new idr.core.ActionsController,this._storyboardDiv=null,this._workbookDiv=null,this._workbookContainerDiv=null,this._livePreviewDiv=null,this._init=!1,this._workbookReady=!1,this._storyboardReady=!1,this._livePreviewReady=!1,this._editorReady=!1,this._livePreviewEnabled=void 0!==settings.livePreviewEnabled?settings.livePreviewEnabled:!0,idr.core.Editor.instance=this,this.initialize()},idr.core.Editor.dictionary={editor:{},storyboard:{},workbook:{}};var ACTION_EDITOR_UNDO=new idr.core.Action("EDITOR.UNDO","Ctrl-Z"),ACTION_EDITOR_REDO=new idr.core.Action("EDITOR.REDO","Ctrl-Y");idr.core.Editor.prototype.initialize=function(){idr.debug.log("Initializing Editor ...");var that=this,storyboardOnReadyCallback=function(){that.registerEditorActions(),that.initializeView(),document.addEventListener("keyup",function(event){that._actionsController.dispatchKeyboardEvent(event)},!1),document.addEventListener("keydown",function(event){return event.ctrlKey&&85==event.keyCode?(event.preventDefault(),!1):void 0},!1),that._storyboardReady=!0,idr.debug.log("storyboard Ready!"),that.checkEditorReady()},workbookOnReadyCallback=function(){that._workbookReady=!0,idr.debug.log("Workbook Ready !"),that.checkEditorReady(),that._binder=new idr.core.DefaultBinder(that._workbookController.getWorkbookEngine()),idr.components.Component.Binder=that._binder},livePreviewOnReadyCallback=function(){that._livePreviewReady=!0,idr.debug.log("livePreview Ready!"),that.checkEditorReady(),that._livePreview.setSharedWorkbook(that._workbookController.getWorkbookEngine()),void 0!==window.top.xdk&&window.top.$(".tab_content[data-title=edit]").trigger("LivePreviewConnected")};this._workbookController.initialize(workbookOnReadyCallback),this._storyboard.initialize(storyboardOnReadyCallback),this._livePreview.initialize(livePreviewOnReadyCallback),this._init=!0},idr.core.Editor.prototype.initializeView=function(){var that=this;if(this._workbookContainerDiv=$("#workbook-container"),this._storyboardDiv=$("div#storyboard-panel"),this._workbookDiv=$("div#workbook-panel"),this._livePreviewEnabled){this._livePreviewDiv=$("div#livepreview-panel");var livepreviewView=this._livePreview.view();this._livePreviewDiv.append(livepreviewView)}this._storyboardDiv.focus(function(){that._workbookController.setFocus(!1),that._storyboard.setFocus(!0)}),this._workbookDiv.mousedown(function(){that._workbookController.setFocus(!0),that._storyboard.setFocus(!1)});var afuiDiv=$("<div id='afui' style='width: 100%; height: 100%;'></div>"),storyboardView=this._storyboard.view();afuiDiv.append(storyboardView),this._storyboardDiv.append(afuiDiv);var workbookView=this._workbookController.view();this._workbookDiv.append(workbookView),window.onresize=function(){that.resize(),that._workbookContainerDiv.idrResizable("resize")},this.setupResizeComponents(),this._storyboard.viewAddedToDOM(),this._workbookController.viewAddedToDOM(),this._livePreview.viewAddedToDOM()},idr.core.Editor.prototype.newProject=function(){this.clean()},idr.core.Editor.prototype.clean=function(){var that=this;this._storyboard.reset(),this._workbookController.clean(function(){var workbookView=this._workbookController.view();that._workbookDiv.empty(),that._workbookDiv.append(workbookView)}),this._livePreview.reset()},idr.core.Editor.prototype.connectLivePreview=function(newWindow){this._livePreview.connectWindow(newWindow)},idr.core.Editor.prototype.pushStateToLivePreview=function(){var editorObj=null;try{return editorObj=JSON.parse(this.serializeToJson()),editorObj&&(this.pushIntoLivePreview(this,{type:"BINDER_LOAD",data:editorObj.binder}),this._livePreview.pushStoryboardState(editorObj)),!0}catch(e){return!1}},idr.core.Editor.prototype.setupResizeComponents=function(){var that=this;this._workbookContainerDiv.idrResizable({single:!0,autoHandlers:!1,stop:function(event,resizeData){that.resizePanel(that._workbookContainerDiv,resizeData.heightPercentage),that.showWorkbook(resizeData.height>16)}}),$("#workbook-divider-toggle").on("click",this.toggleWorkbook.bind(this))},idr.core.Editor.prototype.toggleWorkbook=function(){var isHidden=this._workbookContainerDiv.hasClass("hide-h");this._workbookContainerDiv.css("height",""),this._workbookContainerDiv.xdkHeight=null,this.showWorkbook(isHidden),this.resizeEditor(),this.resize(),this._workbookContainerDiv.idrResizable("resize")},idr.core.Editor.prototype.showWorkbook=function(show){var slider=this._workbookContainerDiv.find("#workbook-divider-toggle");show?(this._workbookContainerDiv.removeClass("hide-h"),slider.removeClass("top").addClass("bottom")):(this._workbookContainerDiv.addClass("hide-h"),slider.removeClass("bottom").addClass("top"),this._workbookController.setFocus(!1))},idr.core.Editor.prototype.resizePanel=function($targetPanel,height){$targetPanel.removeClass("hide-h"),$targetPanel.css("height",height+"%"),$targetPanel.xdkHeight=height,this.resizeEditor(),this.resize(),$targetPanel.idrResizable("resize")},idr.core.Editor.prototype.resizeEditor=function(){var calcHeight=this._workbookContainerDiv.xdkHeight,heightValue=calcHeight?calcHeight+"%":this._workbookContainerDiv.css("height"),storyboardWidth="calc(100% - "+heightValue+")";$("#storyboard-panel").css("height",storyboardWidth)},idr.core.Editor.prototype.resize=function(){var mainPanelWidth=$(this._workbookDiv).width(),height=$(this._workbookDiv).height();this._workbookController.workbookResize(mainPanelWidth,height-14)},idr.core.Editor.prototype.registerEditorActions=function(){this.registerAction(this,ACTION_EDITOR_UNDO),this.registerAction(this,ACTION_EDITOR_REDO)},idr.core.Editor.prototype.pushIntoHistory=function(component,interactionData){this._actionsController.pushIntoHistory(component,interactionData)},idr.core.Editor.prototype.registerAction=function(component,action){this._actionsController.registerAction(component,action)},idr.core.Editor.prototype.receiveAction=function(actionKey){actionKey===ACTION_EDITOR_UNDO.Key&&(idr.debug.log("Undo"),this._actionsController.undoFromHistory()),actionKey===ACTION_EDITOR_REDO.Key&&(idr.debug.log("Redo"),this._actionsController.redoFromHistory())},idr.core.Editor.prototype.undoHistoryRequested=function(){},idr.core.Editor.prototype.redoHistoryRequested=function(){},idr.core.Editor.prototype.pushIntoLivePreview=function(component,interactionData){try{this._livePreview.pushFromStoryboard(interactionData)}catch(e){idr.debug.log("Error pushing changes into LivePreview: "+e)}},idr.core.Editor.prototype.serializeToJson=function(){var editorObj={storyboard:this._storyboard.rawData(),workbook:this._workbookController.serializeToJson(),binder:this._binder.toRawObject(),program:{startPage:idr.components.PageBase._startPage}};return JSON.stringify(editorObj)},idr.core.Editor.prototype.serializeTemplate=function(){for(var editorObj={storyboard:this._storyboard.rawData(),workbook:this._workbookController.serializeToJson(),binder:this._binder.toRawObject()},idMap={},instances=editorObj.storyboard,i=0;i<instances.length;i++)idMap[instances[i].instanceId.replace(/idr-obj/g,"#template-obj#")]=1;var ids=Object.keys(idMap);editorObj.ids=ids;var strObj=JSON.stringify(editorObj),strReplaced=strObj.replace(/idr-obj/g,"#template-obj#");return strReplaced},idr.core.Editor.prototype.loadFromJson=function(strJson){var editorObj=null;try{if(editorObj=JSON.parse(strJson)){var programObj=editorObj.program;idr.components.PageBase._startPage=programObj?programObj.startPage:null,this._binder.fromRawObject(editorObj.binder),this.pushIntoLivePreview(this,{type:"BINDER_LOAD",data:editorObj.binder}),this._workbookController.loadFromJson(editorObj.workbook),this._storyboard.loadFromRawData(editorObj.storyboard);var jsonData=JSON.stringify({pageId:idr.components.PageBase._startPage});this.pushIntoLivePreview(this,{type:"START_PAGE_CHANGED",data:jsonData})}return!0}catch(e){return idr.debug.log("Failed to load program from json: "+e),!1}},idr.core.Editor.prototype.loadTemplate=function(template,viewData){if(this.replaceTemplateIds(template),template){var offset=this._workbookController.loadTemplate(template.Data.workbook);this._storyboard.loadTemplate(template.Data.storyboard,viewData),this._binder.bindTemplate(template.Data,offset)}},idr.core.Editor.prototype.replaceTemplateIds=function(template){for(var ids=template.Data.ids,idsMap={},i=0;i<ids.length;i++)idsMap[ids[i]]=this._storyboard.nextId();for(var strObj=JSON.stringify(template.Data),j=0;j<ids.length;j++){var id=ids[j],patt=new RegExp(id,"g");strObj=strObj.replace(patt,idsMap[id])}template.Data=JSON.parse(strObj)},idr.core.Editor.prototype.isReady=function(){return this._isReady},idr.core.Editor.prototype.checkEditorReady=function(){this._workbookReady&&this._storyboardReady&&this._livePreviewReady&&(this._isReady=!0)},idr.core.Editor.prototype.getText=function(key){return this._dictionary[key]},idr.core.Editor.prototype.highligthFormula=function(formulaText){this._workbookController.highligthFormula(formulaText)},idr.core.Editor.prototype.unhighlightFormula=function(formulaText){this._workbookController.unhighlightFormula(formulaText)},idr.core.Editor.prototype.hookToViewEvent=function(componentName,eventName,callback){return"workbook"===componentName?this._workbookController.hookToViewEvent(eventName,callback):"storyboard"===componentName?this._storyboard.hookToViewEvent(eventName,callback):"livepreview"===componentName?this._livePreview.hookToViewEvent(eventName,callback):void 0},idr.core.Editor.prototype.solveNameToSelector=function(mainName,subName,options){var response=this._storyboard.solveNameToSelector(mainName,subName,options);return null===response&&(response=this._workbookController.solveNameToSelector(mainName,subName,options)),null===response.iframe&&(response.iframe="app-creator-frame"),response},idr.core.Editor.prototype.listenOneTimeEvent=function(itemName,eventName,args,callback){"storyboard"===itemName||0===itemName.indexOf("idr-obj-")?this._storyboard.listenOneTimeEvent(itemName,eventName,args,callback):"workbook"===itemName&&this._workbookController.listenOneTimeEvent(itemName,eventName,args,callback)},idr.core.Editor.prototype.getAnalytics=function(){var analyticsObj={storyboard:this._storyboard.getAnalytics(),workbook:this._workbookController.getAnalytics()};return analyticsObj},idr.core.Editor.prototype.baseView=function(){return this._baseView},idr.core.Editor.prototype.baseOffset=function(){for(var sumWidth=0,i=0,len=this._baseSelectors.length;len>i;i++){var currentDiv=this._baseView.find(this._baseSelectors[i]);0!==currentDiv.length&&(sumWidth+=$(currentDiv).width())}var offset={top:0,left:sumWidth};return offset},idr.core.Editor.prototype.isEmptyProject=function(){return this._storyboard.isEmpty()&&this._workbookController.isEmpty()?!0:!1},idr.core.Editor.prototype.clearFocus=function(){this._workbookController.setFocus(!1),this._storyboard.setFocus(!1)},idr.core.Editor.prototype.setStoryboardZoom=function(zoomValue){this._storyboard.setZoom(zoomValue)},idr.core.Editor.prototype.storyboardZoom=function(){return this._storyboard.zoom()};