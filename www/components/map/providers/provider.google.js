/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.require("idr.components.Provider"),goog.provide("idr.components.ProviderGoogle"),idr.components.ProviderGoogle=function(controller){this._controller=controller,this._map=null,this._pointsViews={},this._userPointView=null,this._markerPopup=null,this._onMapLibraryReadyCallback=this.libraryReadyCallback.bind(this),idr.components.ProviderGoogle._libLoaded=void 0!==window.google&&void 0!==window.google.maps,idr.components.ProviderGoogle._libLoaded===!1&&$(document).bind("mapLibReady",this._onMapLibraryReadyCallback)},idr.components.ProviderGoogle._loadingLibrary=!1,idr.components.ProviderGoogle._libLoaded=!1,idr.components.ProviderGoogle.prototype.initialize=function(){this.isMapLibraryReady()===!1?this.loadMapScript():this.initializeMap()},idr.components.ProviderGoogle.libraryReady=function(){$(document).trigger("mapLibReady")},idr.components.ProviderGoogle.prototype.loadMapScript=function(){idr.components.ProviderGoogle._loadingLibrary||(idr.components.ProviderGoogle._loadingLibrary=!0,setTimeout(function(){var scriptUrl="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&callback=idr.components.ProviderGoogle.libraryReady",mapScript=document.createElement("script");mapScript.type="text/javascript",mapScript.async=!0,mapScript.src=scriptUrl,mapScript.onerror=function(){console.log("error loading the script")},document.body.appendChild(mapScript)},10))},idr.components.ProviderGoogle.prototype.isMapLibraryReady=function(){return idr.components.ProviderGoogle._libLoaded},idr.components.ProviderGoogle.prototype.libraryReadyCallback=function(){$(document).unbind("mapLibReady",this._onMapLibraryReadyCallback),idr.components.ProviderGoogle._libLoaded=!0,this.initializeMap()},idr.components.ProviderGoogle.prototype.initializeMap=function(){this._markerPopup=new google.maps.InfoWindow,this.renderMap(),this._controller.onProviderReady()},idr.components.ProviderGoogle.prototype.renderMap=function(){var mapOptions={center:new google.maps.LatLng(-31.4199102,-64.1831344),zoom:14,mapTypeControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}},mapView=this._controller.mapView()[0];this._map=new google.maps.Map(mapView,mapOptions),this.notifyMapCreated()},idr.components.ProviderGoogle.prototype.destroyMap=function(){this._map=null,this._pointsViews={},this._controller.notifyMapDestroyed()},idr.components.ProviderGoogle.prototype.addOrUpdatePoint=function(point){void 0===this._pointsViews[point.key]?this.addPoint(point):this.updatePoint(point)},idr.components.ProviderGoogle.prototype.addPoint=function(point){var that=this,position=new google.maps.LatLng(point.lat,point.lng),marker=new google.maps.Marker({position:position,map:this._map});this._map.setCenter(position),this._pointsViews[point.key]=marker,google.maps.event.addListener(marker,"click",function(){that.showPopup(point.key,marker)})},idr.components.ProviderGoogle.prototype.showPopup=function(key,pointView){null!==this._markerPopup&&(this._markerPopup.close(),$(this._markerPopup.getContent()).off());var that=this,pointData=this._controller.formattedPoint(key)[0];$(pointData).on("click",function(){that.notifyPointSelected(key)}),this._markerPopup.setContent(pointData),this._markerPopup.open(this._map,pointView)},idr.components.ProviderGoogle.prototype.updatePoint=function(point){var marker=this._pointsViews[point.key],position=new google.maps.LatLng(point.lat,point.lng);marker.setPosition(position),this._map.setCenter(position)},idr.components.ProviderGoogle.prototype.deletePoint=function(point){var marker=this._pointsViews[point.key];void 0!==marker&&(marker.setMap(null),delete this._pointsViews[point.key])},idr.components.ProviderGoogle.prototype.deleteAllPoints=function(){for(var key in this._pointsViews)this._pointsViews[key].setMap(null);this._pointsViews={}},idr.components.ProviderGoogle.prototype.showMyLocation=function(location){var pos=new google.maps.LatLng(location.lat,location.lng);null===this._userPointView&&(this._userPointView=new google.maps.Marker({icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}),this._userPointView.setMap(this._map)),this._userPointView.setAnimation(google.maps.Animation.DROP),this._userPointView.setPosition(pos),this._map.setCenter(pos)},idr.components.ProviderGoogle.prototype.hideMyLocation=function(){null!==this._userPointView&&(this._userPointView.setMap(null),this._userPointView=null)},idr.components.ProviderGoogle.prototype.onResize=function(){this.isMapLibraryReady()&&google.maps.event.trigger(this._map,"resize")},idr.components.ProviderGoogle.prototype.notifyMapCreated=function(){this._controller.onMapCreated instanceof Function&&this._controller.onMapCreated()},idr.components.ProviderGoogle.prototype.notifyMapDestroyed=function(){this._controller.onMapDestroyed instanceof Function&&this._controller.onMapDestroyed()},idr.components.ProviderGoogle.prototype.notifyPointSelected=function(key){this._controller.onPointSelected instanceof Function&&this._controller.onPointSelected(key)};