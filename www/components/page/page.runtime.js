/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.runtime.Page"),goog.require("idr.runtime.ComponentRuntime"),goog.require("idr.components.PageBase"),idr.runtime.Page=function(id,data,parent){idr.components.PageBase.call(this,id,data,parent),this.initializeRuntime(data),this.loadCss("page","page.runtime.css"),this._headerDiv=null,this._titleMarkup=null,this._menuBadgeDiv=null,this._contentDiv=null,this.initialize(),idr.runtime.Page._activePanels.push(this),this._loadPageCallback=this.onPageLoaded.bind(this),this.addPropertyChangedHandler("title",function(){this._titleMarkup.text(this.title())}),this.addPropertyChangedHandler("showHeader",function(){"header"==this._headerDiv.parent().attr("id")&&$.ui.toggleHeaderMenu(this.showHeader())}),this.addPropertyChangedHandler("contentPadding",function(){this._contentDiv.removeClass(function(index,css){return(css.match(/\bidr-page-padding-\S+/g)||[]).join(" ")}),this._contentDiv.addClass(this.contentPadding())}),this.addPropertyChangedHandler("stackPadding",function(){this._contentDiv.removeClass(function(index,css){return(css.match(/\bstack-padding-\S+/g)||[]).join(" ")}),this._contentDiv.addClass(this.stackPadding())}),this.addPropertyChangedHandler("headerBGColor",function(){this.updateHeaderBGColor()}),this.addPropertyChangedHandler("contentBGColor",function(){this._contentDiv.css("background-color","#"+this.contentBGColor())}),this.addPropertyChangedHandler("headerFontColor",this.applyHeaderFontColor),this.addPropertyChangedHandler("currentMapping",function(){var data=this.currentMapping();this.updateFormFactorForChild(data.id,data.formFactor,data.newValue,data.oldValue)})},idr.runtime.Page._activePanels=[],idr.runtime.Page.updateStartPage=function(pageId){idr.components.PageBase._startPage=pageId;var pageInstance=_instances[idr.components.PageBase._startPage];pageInstance?pageInstance.makeFirstAndShow():$.ui.loadContent("_emptyPage")},idr.runtime.Page.showStartPageIfNeeded=function(){if("_notConfig"===idr.components.PageBase._startPage){var pageInstance=null;for(var id in _instances)if(pageInstance=_instances[id],pageInstance instanceof idr.runtime.Page)break;null!==pageInstance?(idr.components.PageBase._startPage=pageInstance.Id,pageInstance.makeFirstAndShow()):(idr.components.PageBase._startPage=null,$.ui.loadContent("_emptyPage"))}},goog.inherits(idr.runtime.Page,idr.components.PageBase),goog.mixin(idr.runtime.Page.prototype,idr.runtime.ComponentRuntime.prototype),idr.runtime.Page.prototype.applyHeaderFontColor=function(){this._titleMarkup.css("color","#"+this.headerFontColor())},idr.runtime.Page.prototype.applyBGColor=function(){this._contentDiv.css("background-color","#"+this.contentBGColor())},idr.runtime.Page.prototype.updateHeaderBGColor=function(){var color=this.headerBGColor();""!==color&&(color="#"+color),this._headerDiv.parent().css("background-color",color),this._headerDiv.parent().css("border-bottom-color",color)},idr.runtime.Page.prototype.initialize=function(){if(this._content=$("#content"),0===this._content.length&&(this._content=$("<div id=content></div>"),$("#afui").append(this._content)),this._menuBadgeDiv=$("#menubadge"),0===this._menuBadgeDiv.length){this._menuBadgeDiv=$('<a id="menubadge" class="menuButton"></a>'),this._menuBadgeDiv.on("click",function(){af.ui.toggleSideMenu()});var menuContainer=$("#hiddenMenu");menuContainer.append(this._menuBadgeDiv)}},idr.runtime.Page.prototype.render=function(){var id=this.Id,that=this;this._headerDiv=$("<header id='header_"+id+"'/>"),this._titleMarkup=$("<h1>"+this.title()+"</h2>"),this._headerDiv.append('<a class="backButton button">Back</a>'),this._headerDiv.append(this._titleMarkup),this._contentDiv=$("<div id='"+id+"' data-footer='none'></div>"),this._contentDiv.attr("data-header","header_"+id),this.applyBGColor(),this.applyHeaderFontColor(),this._elementsDiv=$('<div class="idr-fluid-stack"></div>'),this._contentDiv.append(this._headerDiv),this._contentDiv.append(this._elementsDiv),this._contentDiv.click(function(){that.fireEvent("ONCLICK")}),$.ui.addContentDiv(this._contentDiv),this._contentDiv.addClass(this.stackPadding()),this._contentDiv.addClass(this.contentPadding()),$(this._contentDiv).bind("loadpanel",this._loadPageCallback),this.setUpAsStartIfNeeded()},idr.runtime.Page.prototype.setUpAsStartIfNeeded=function(){idr.components.PageBase.isStartPage(this)&&this.makeFirstAndShow()},idr.runtime.Page.prototype.makeFirstAndShow=function(){if(this.isSideMenuActivatedDummy()){var result=this._headerDiv.find("#menubadge");0===result.length&&this._headerDiv.append(this._menuBadgeDiv)}this.showFirst()},idr.runtime.Page.prototype.showFirst=function(){this.show(),$.ui.clearHistory(),this.isSideMenuActivatedDummy()&&0!==this._menuBadgeDiv.length&&this._menuBadgeDiv.css("float","left")},idr.runtime.Page.prototype.show=function(){return 0===$("#"+this.Id).length?void console.log("Warning! panel does not exists in DOM. MEMORY LEAK!!"):void $.ui.loadContent("#"+this.Id)},idr.runtime.Page.prototype.isSideMenuActivatedDummy=function(){return!0},idr.runtime.Page.prototype.onPageLoaded=function(){this.updateHeaderBGColor(),$.ui.toggleHeaderMenu(this.showHeader()),this.notifyComponentLoaded()},idr.runtime.Page.prototype.view=function(){return null===this._view&&this.render(),this._view},idr.runtime.Page.prototype.componentDeleted=function(){var index=idr.runtime.Page._activePanels.indexOf(this);idr.runtime.Page._activePanels.splice(index,1),$(this._contentDiv).unbind("loadpanel",this._loadPageCallback),this._contentDiv.empty(),this._contentDiv.remove(),this._headerDiv.remove(),this.showNextPageIfNeeded(),idr.components.PageBase.prototype.componentDeleted.call(this)},idr.runtime.Page.prototype.showNextPageIfNeeded=function(){if(null!==$.ui.activeDiv&&$.ui.activeDiv.id===this.Id){var panelsSize=idr.runtime.Page._activePanels.length;if(panelsSize>0)for(var i=0;panelsSize>i;i++){var current=idr.runtime.Page._activePanels[i];if(idr.components.PageBase.isStartPage(current)){current.showFirst();break}}}},idr.runtime.Page.prototype.onChildrenAdded=function(child){var formFactorClasses=this.getChildFormFactorsClasses(child.Id,"col-2"),childMarkup=$("<div></div>");childMarkup.addClass("idr-fluid-item"),childMarkup.addClass(formFactorClasses),childMarkup.attr("data-id",child.Id),childMarkup.append(child.view().addClass("nomargin")),this._elementsDiv.append(childMarkup),child.height&&this.updateChildComponentHeight(child,child.height()),child.componentAdded()},idr.runtime.Page.prototype.onChildrenRemoved=function(child){var itemView=this._elementsDiv.find('[data-id="'+child.Id+'"]');itemView&&itemView.remove()},idr.runtime.Page.prototype.updateFormFactorForChild=function(childId,formFactor,newValue,oldValue){var itemView=this._elementsDiv.find('[data-id="'+childId+'"]');itemView&&(itemView.removeClass(oldValue),itemView.addClass(newValue))};