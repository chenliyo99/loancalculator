/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.runtime.RssFeedReader"),goog.require("idr.components.RssFeedException"),idr.runtime.RssFeedReader=function(){this._xhr=new XMLHttpRequest,this._xhr.timeout=idr.runtime.RssFeedReader.DEFAULT_TIMEOUT,this._parsers={rss:this.parseRSSFeed,feed:this.parseAtomFeed}},idr.runtime.RssFeedReader.DEFAULT_TIMEOUT=8e3,idr.runtime.RssFeedReader.prototype.load=function(url,onSuccess,onError){if("string"==typeof url&&""!==url){var that=this;this._xhr.onreadystatechange=function(){that.onFeedReady(onSuccess,onError)},this._xhr.ontimeout=function(){that.handleError(onError,idr.components.RssFeedException.ERRORS.timeout)},this._xhr.open("GET",url,!0),this._xhr.send(null)}},idr.runtime.RssFeedReader.prototype.setTimeout=function(timeout){this._xhr.timeout=timeout},idr.runtime.RssFeedReader.prototype.onFeedReady=function(onSuccess,onError){if(this._xhr&&4==this._xhr.readyState)if(200==this._xhr.status)try{var data=this.parseFeed(this._xhr.responseText);onSuccess instanceof Function&&onSuccess(data)}catch(err){this.handleError(onError,err)}else this.handleError(onError,idr.components.RssFeedException.ERRORS.request)},idr.runtime.RssFeedReader.prototype.parseFeed=function(data){if("string"!=typeof data)return null;var dataResult=null,xmlData=null;try{xmlData=$.parseXML(data)}catch(e){throw idr.components.RssFeedException.ERRORS.dataFormat}if(null!==xmlData){var feedType=$(xmlData).first().children().first()[0].tagName,parseFn=this._parsers[feedType];if(!(parseFn instanceof Function))throw idr.components.RssFeedException.ERRORS.feedParser;dataResult=parseFn.call(this,xmlData)}return dataResult},idr.runtime.RssFeedReader.prototype.parseRSSFeed=function(xmlData){var feedResult={};feedResult.feedUrl="",feedResult.link="",feedResult.author="",feedResult.description="",feedResult.entries=[];for(var entries=$(xmlData).find("item"),i=0;i<entries.length;i++)try{var entry={};entry.publishedDate=$(entries[i]).find("pubDate").text().trim(),entry.title=$(entries[i]).find("title").text().trim(),entry.link=$(entries[i]).find("link").text().trim(),entry.content=$(entries[i]).find("description").text().trim(),entry.contentSnippet=this.extractContentSnippet(entry.content),entry.image=this.extractImage(entry.content),feedResult.entries.push(entry)}catch(e){throw idr.components.RssFeedException.ERRORS.format}return feedResult},idr.runtime.RssFeedReader.prototype.parseAtomFeed=function(){throw idr.components.RssFeedException.ERRORS.atomFormat},idr.runtime.RssFeedReader.prototype.extractContentSnippet=function(content){var contentWrapper=$("<div>"+content+"</div>"),result=$(contentWrapper).find("p").text().trim();return result=""===result?$(contentWrapper).text():result,result.length>120?result.substr(0,120)+"...":result},idr.runtime.RssFeedReader.prototype.extractImage=function(content){var contentWrapper=$("<div>"+content+"</div>"),result=contentWrapper.find("img").attr("src");return void 0===result?"":result},idr.runtime.RssFeedReader.prototype.handleError=function(onError,errorData){onError instanceof Function&&onError(errorData)};