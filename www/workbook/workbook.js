/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.workbook.Workbook"),goog.require("goog.structs.Map"),goog.require("idr.debug"),goog.require("idr.workbook.Worksheet"),goog.require("idr.workbook.CellFormat"),goog.require("idr.commons.ToolbarTarget"),goog.require("goog.date.Date"),goog.require("goog.i18n.DateTimeFormat"),goog.require("goog.i18n.DateTimeFormat.Format"),goog.require("goog.i18n.NumberFormat"),goog.require("goog.i18n.NumberFormat.Format"),goog.require("idr.workbook.Runtime"),idr.workbook.Workbook=function(){this._worksheets=new goog.structs.Map,this._runtime=new idr.workbook.Runtime,this._onWorksheetChangedCallback=null,this.addWorksheet("default"),this._cellChangedBuffer=[],this._bufferChanged=!1,this._isFilling=!1,this._currentCell=null},goog.mixin(idr.workbook.Workbook.prototype,idr.commons.ToolbarTarget.prototype),idr.workbook.Workbook.WORKSHEET_ALREADY_EXISTS_EXCEPTION="worksheetAlreadyExistsException",idr.workbook.Workbook.WORKSHEET_NOT_FOUND_EXCEPTION="worksheetNotFoundException",idr.workbook.Workbook.LAST_WORKSHEET_REMOVE_EXCEPTION="lastWorksheetRemovedException",idr.workbook.Workbook.NO_ACTIVE_WORKSHEET_EXCEPTION="noActiveWorkSheetException",idr.workbook.Workbook.COPY_TYPE={values:1,functions:2,links:3,format:4,style:5,all:6},idr.workbook.Workbook.prototype.getMaxUserRows=function(){return this._runtime.getMaxUserRows()},idr.workbook.Workbook.prototype.getRuntime=function(){return this._runtime},idr.workbook.Workbook.prototype.clean=function(){for(var keys=this._worksheets.getKeys(),i=0;i<keys.length;i++)this._worksheets.remove(keys[i]);this.addWorksheet("default")},idr.workbook.Workbook.prototype.addWorksheet=function(name){var worksheet=null;if(this._worksheets.containsKey(name))throw new Error(idr.workbook.Workbook.WORKSHEET_ALREADY_EXISTS_EXCEPTION);worksheet=new idr.workbook.Worksheet(name,this._runtime,this),this._worksheets.set(worksheet.Name,worksheet),this.activateWorksheet(worksheet.Name)},idr.workbook.Workbook.prototype.formatCell=function(worksheetName,selectedCells,toolbarDataItem,formatExpression){for(var cellsNames=this._runtime.getCellNamesFromRowColumn(selectedCells),worksheet=this.getWorksheet(worksheetName),formatType=toolbarDataItem.formatType,cellsChanged=[],i=0;i<cellsNames.length;i++){var cell=worksheet.setCellFormat(cellsNames[i],formatType,formatExpression);cellsChanged.push(cell)}this.onWorksheetChanged(worksheetName,cellsChanged,"format")},idr.workbook.Workbook.prototype.setCellFormat=function(worksheet,cellName,formatType,formatExpression){worksheet.setCellFormat(cellName,formatType,formatExpression)},idr.workbook.Workbook.prototype.styleCell=function(worksheetName,row,col,markup){var cellName=this._runtime.rowColumnToCellName(row,col),worksheet=this.getWorksheet(worksheetName);worksheet.applyCellStyle(cellName,markup)},idr.workbook.Workbook.prototype.setCellsFontStyle=function(worksheetName,selectedCells,toolbarDataItem){var fontStyle=toolbarDataItem.formatType,value=!0;this._currentCell&&this._currentCell.CellStyle&&(value=!this._currentCell.CellStyle.getFontStyle(fontStyle)),this.performCellStyle(worksheetName,"setCellsFontStyle",selectedCells,fontStyle,value)},idr.workbook.Workbook.prototype.setCellsBackground=function(worksheetName,selectedCells,toolbarDataItem,color){this.performCellStyle(worksheetName,"setCellsBackground",selectedCells,color)},idr.workbook.Workbook.prototype.setCellsFontColor=function(worksheetName,selectedCells,toolbarDataItem,color){this.performCellStyle(worksheetName,"setCellsFontColor",selectedCells,color)},idr.workbook.Workbook.prototype.setCellsFontSize=function(worksheetName,selectedCells,toolbarDataItem,size){this.performCellStyle(worksheetName,"setCellsFontSize",selectedCells,size)},idr.workbook.Workbook.prototype.setCellsFontFamily=function(worksheetName,selectedCells,toolbarDataItem,family){this.performCellStyle(worksheetName,"setCellsFontFamily",selectedCells,family)},idr.workbook.Workbook.prototype.setCellsAlignmentCenter=function(worksheetName,selectedCells){this.performCellStyle(worksheetName,"setCellsAlignment",selectedCells,"center")},idr.workbook.Workbook.prototype.setCellsAlignmentRight=function(worksheetName,selectedCells){this.performCellStyle(worksheetName,"setCellsAlignment",selectedCells,"right")},idr.workbook.Workbook.prototype.setCellsAlignmentLeft=function(worksheetName,selectedCells){this.performCellStyle(worksheetName,"setCellsAlignment",selectedCells,"left")},idr.workbook.Workbook.prototype.performCellStyle=function(worksheetName,action,selectedCells,style,value){for(var cellsNames=this._runtime.getCellNamesFromRowColumn(selectedCells),worksheet=this.getWorksheet(worksheetName),i=0;i<cellsNames.length;i++)worksheet[action](cellsNames[i],style,value);this.onWorksheetRenderChanged(worksheetName)},idr.workbook.Workbook.prototype.getWorksheet=function(name){if(!this._worksheets.containsKey(name))throw new Error(idr.workbook.Workbook.WORKSHEET_NOT_FOUND_EXCEPTION);return this._worksheets.get(name)},idr.workbook.Workbook.prototype.removeWorksheet=function(name){if(!this._worksheets.containsKey(name))throw new Error(idr.workbook.Workbook.WORKSHEET_NOT_FOUND_EXCEPTION);if(!(this._worksheets.getCount()>1))throw new Error(idr.workbook.Workbook.LAST_WORKSHEET_REMOVE_EXCEPTION);this._worksheets.remove(name)},idr.workbook.Workbook.prototype.getWorksheetCount=function(){return this._worksheets.getCount()},idr.workbook.Workbook.prototype.activateWorksheet=function(name){if(!this._worksheets.containsKey(name))throw new Error(idr.workbook.Workbook.WORKSHEET_NOT_FOUND_EXCEPTION);var sheetKeys=this._worksheets.getKeys();for(var i in sheetKeys){var sheet=this._worksheets.get(sheetKeys[i]);sheet.Active=sheet.Name===name?!0:!1}},idr.workbook.Workbook.prototype.getActiveWorksheet=function(){var sheetKeys=this._worksheets.getKeys();for(var i in sheetKeys){var sheet=this._worksheets.get(sheetKeys[i]);if(sheet.Active)return sheet}throw new Error(idr.workbook.Workbook.NO_ACTIVE_WORKSHEET_EXCEPTION)},idr.workbook.Workbook.prototype.setCellToWorksheet=function(worksheetName,cellName,formulaText){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.setCell(cellName,formulaText)}catch(e){}return null},idr.workbook.Workbook.prototype.setCellsByRangeToWorksheet=function(worksheetName,rangeName,defaultFormulaText,data){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.setCellsByRange(rangeName,void 0===defaultFormulaText||null===defaultFormulaText?"":defaultFormulaText,data)}catch(e){}return null},idr.workbook.Workbook.prototype.setCellsByArrayToWorksheet=function(worksheetName,cellsArray){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.setCellsByArray(cellsArray)}catch(e){}return null},idr.workbook.Workbook.prototype.setCellsByCopyToWorksheet=function(worksheetName,fromCellOrRangeName,toCellOrRangeName,copyType){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.setCellsByCopy(fromCellOrRangeName,toCellOrRangeName,copyType)}catch(e){}return null},idr.workbook.Workbook.prototype.setCellsByStringToWorksheet=function(worksheetName,toCellName,strData){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.setCellsByString(toCellName,strData)}catch(e){}return null},idr.workbook.Workbook.prototype.getCellFromWorksheet=function(worksheetName,cellName){var worksheet=this.getWorksheet(worksheetName);return worksheet.getCell(cellName)},idr.workbook.Workbook.prototype.getCellsByRangeFromWorksheet=function(worksheetName,rangeName,createIfNotExists){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.getCellsByRange(rangeName,createIfNotExists)}catch(e){}return null},idr.workbook.Workbook.prototype.getFreeRangeFromWorksheet=function(worksheetName,rows,cols){try{var worksheet=this.getWorksheet(worksheetName);return worksheet.getFreeRange(rows,cols)}catch(e){}return null},idr.workbook.Workbook.prototype.addWorksheetChangedCallback=function(callback){$(this).on("change",callback)},idr.workbook.Workbook.prototype.removeWorksheetChangedCallback=function(callback){$(this).off("change",callback)},idr.workbook.Workbook.prototype.addWorksheetRenderChangedCallback=function(callback){$(this).bind("rendercell",callback)},idr.workbook.Workbook.prototype.removeWorksheetRenderChangedCallback=function(callback){$(this).unbind("rendercell",callback)},idr.workbook.Workbook.prototype.onWorksheetChanged=function(name,cells,changeType){var self=this;if(this.addToBuffer(cells),!this._isFilling){this._isFilling=!0;var timeout=setInterval(function(){self.checkForChanges()&&(clearInterval(timeout),self._isFilling=!1,self.flushBuffer(name,changeType))},100)}},idr.workbook.Workbook.prototype.onWorksheetRenderChanged=function(){$(this).trigger("rendercell")},idr.workbook.Workbook.prototype.addToBuffer=function(cells){var length=cells.length,buffer=this._cellChangedBuffer,cellsInBuffer=this._cellsInBuffer;void 0===cellsInBuffer&&(cellsInBuffer=this._cellsInBuffer={});for(var i=0;length>i;i++){var cell=cells[i];void 0===cellsInBuffer[cell.Name]&&(buffer.push(cell),cellsInBuffer[cell.Name]=!0)}this._bufferChanged=!0},idr.workbook.Workbook.prototype.checkForChanges=function(){return this._bufferChanged?(this._bufferChanged=!1,!0):!1},idr.workbook.Workbook.prototype.flushBuffer=function(name,changeType){try{$(this)&&$(this).trigger("change",[name,this._cellChangedBuffer,changeType])}catch(e){idr.debug.log("Error flushing buffer: "+e)}this._cellChangedBuffer=[],this._cellsInBuffer={}},idr.workbook.Workbook.prototype.toJson=function(){var workbookJson=[],worksheetsNames=this._worksheets.getKeys();for(var i in worksheetsNames){var worksheet=this._worksheets.get(worksheetsNames[i]);workbookJson.push(worksheet.toJson())}return{worksheets:workbookJson}},idr.workbook.Workbook.prototype.loadFromJson=function(jsonObj){if("object"==typeof jsonObj&&jsonObj.worksheets)for(var worksheets=jsonObj.worksheets,i=0;i<worksheets.length;i++)this.setCellsByArrayToWorksheet(worksheets[i].worksheet,worksheets[i].cells)},idr.workbook.Workbook.prototype.setCurrentCell=function(cell){this._currentCell!==cell&&(this._currentCell=cell)},idr.workbook.Workbook.prototype.getValueForToolbarEntry=function(key){return null!==this._currentCell?idr.workbook.Cell.getState(key,this._currentCell):void 0},idr.workbook.Workbook.prototype.cellNameToRowColumn=function(cellName){return this._runtime.cellNameToRowColumn(cellName)},idr.workbook.Workbook.prototype.rowColumnToCellName=function(row,column){return this._runtime.rowColumnToCellName(row,column)},idr.workbook.Workbook.prototype.rowColumnToRangeName=function(rowColumnFrom,rowColumnTo){return this._runtime.rowColumnToRangeName(rowColumnFrom,rowColumnTo)},idr.workbook.Workbook.prototype.loadTemplate=function(jsonObj){var offset={row:0,column:0};if("object"==typeof jsonObj&&jsonObj.worksheets)for(var worksheets=jsonObj.worksheets,i=0;i<worksheets.length;i++)try{var worksheet=this.getWorksheet(worksheets[i].worksheet),cellArray=this._runtime.removeBinderCellsFromArray(worksheets[i].cells.slice());offset=worksheet.setCellsByCopyToFreeRange(cellArray)}catch(e){console.log(e)}return offset},idr.workbook.Workbook.prototype.getAnalytics=function(){var metricsObj={},metrics=this.getCellsMetrics();return metricsObj.allCellsCounter=metrics[0],metricsObj.cellsWithDataCounter=metrics[1],metricsObj.cellsWithFormatCounter=metrics[2],metricsObj.cellsWithFormulas=metrics[3],metricsObj.functionsCounter=metrics[4],metricsObj},idr.workbook.Workbook.prototype.getCellsMetrics=function(){var metrics=[0,0,0,0,0];try{var worksheet=this.getWorksheet("default"),cells=worksheet.getCells(),fnRegex=new RegExp(FORMULA_REGEX,"g");metrics[0]=cells.length;for(var i=0;i<cells.length;i++)if(""!==cells[i].FormulaText&&metrics[1]++,cells[i].CellFormat&&0!==cells[i].CellFormat.FormatType&&metrics[2]++,this._runtime.isFormula(cells[i].FormulaText)){metrics[3]++;var fnMatch=cells[i].FormulaText.match(fnRegex);fnMatch&&(metrics[4]+=fnMatch.length)}}catch(e){console.log(e)}return metrics},idr.workbook.Workbook.prototype.isEmpty=function(){var sheetKeys=this._worksheets.getKeys();for(var i in sheetKeys){var sheet=this._worksheets.get(sheetKeys[i]);if(!sheet.isEmpty())return!1}return!0};