/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.workbook.Runtime"),goog.require("idr.workbook.RuntimeBase"),goog.require("idr.workbook.Formula"),goog.require("idr.workbook.DefaultRange");var FORMULA_INDICATOR="=",ABSOLUTE_REF_DECORATOR="$",LETTER_REGEX="[a-zA-Z]{1,2}",NUMBER_REGEX="[0-9]*[0-9]",DECORATOR_ABSOLUTE_REF_REGEX="\\$?",LETTER_DECORATORS_REGEX="\\"+ABSOLUTE_REF_DECORATOR+"?",NUMBER_DECORATORS_REGEX="\\"+ABSOLUTE_REF_DECORATOR+"?",FORMULA_REGEX="(\\w+)\\s*\\(",CELL_NAME_REGEX=DECORATOR_ABSOLUTE_REF_REGEX+"("+LETTER_REGEX+")"+DECORATOR_ABSOLUTE_REF_REGEX+"("+NUMBER_REGEX+")",CELL_NAME_INC_DECORATOR_REGEX="("+DECORATOR_ABSOLUTE_REF_REGEX+LETTER_REGEX+")("+DECORATOR_ABSOLUTE_REF_REGEX+NUMBER_REGEX+")",RANGE_NAME_REGEX="("+CELL_NAME_REGEX+"):("+CELL_NAME_REGEX+")",FORMULA_NAMESPACE_PREFIX="idr.workbook.Formula.";idr.workbook.Runtime=function(){},goog.inherits(idr.workbook.Runtime,idr.workbook.RuntimeBase),idr.workbook.Runtime.MAX_USER_ROWS=65535,idr.workbook.Runtime.prototype.normalizeCellName=function(rawCellName){return void 0===rawCellName||null===rawCellName?rawCellName:rawCellName.toUpperCase()},idr.workbook.Runtime.prototype.getMaxUserRows=function(){return idr.workbook.Runtime.MAX_USER_ROWS},idr.workbook.Runtime.prototype.cellNameToRowColumn=function(cellName){var validCellName=this.validateCellName(cellName);if(null!==validCellName){var columnLetter=validCellName[1],rowNumber=validCellName[2],columnNumber=columnLetter.charCodeAt(0)-65;return 2===columnLetter.length&&(columnNumber=26*(columnNumber+1)+columnLetter.charCodeAt(1)-65),{row:parseInt(rowNumber,10)-1,column:columnNumber}}throw new Error(idr.workbook.RuntimeBase.INVALID_CELL_NAME_EXCEPTION)},idr.workbook.Runtime.prototype.rowColumnToCellName=function(row,column){var columnName="",columnNumber=Math.floor(column/26);return columnName=columnNumber>0?String.fromCharCode(columnNumber-1+65)+String.fromCharCode(column%26+65):String.fromCharCode(column+65),columnName+(row+1)},idr.workbook.Runtime.prototype.rowColumnToRangeName=function(rowColumnFrom,rowColumnTo){var cellNameFrom=this.rowColumnToCellName(rowColumnFrom.row,rowColumnFrom.column),cellNameTo=this.rowColumnToCellName(rowColumnTo.row,rowColumnTo.column);return cellNameFrom+":"+cellNameTo},idr.workbook.Runtime.prototype.cellNameToLetterNumber=function(cellName){var pattern=RegExp(CELL_NAME_INC_DECORATOR_REGEX),validCellName=cellName.match(pattern);if(null===validCellName)return null;var letterNumber={};return validCellName&&(letterNumber.letter=validCellName[1],letterNumber.number=validCellName[2]),letterNumber},idr.workbook.Runtime.prototype.validateCellName=function(cellName){if(void 0!==cellName){var regExpMatch=cellName.match(RegExp("^"+CELL_NAME_REGEX+"$"));if(null!==regExpMatch)return regExpMatch}return null},idr.workbook.Runtime.prototype.validateRangeName=function(rangeName){if(void 0!==rangeName&&"string"==typeof rangeName){var regExpMatch=rangeName.match(RegExp("^"+RANGE_NAME_REGEX+"$"));if(null!==regExpMatch)return regExpMatch}return null},idr.workbook.Runtime.prototype.isFormula=function(formulaText){return void 0!==formulaText&&null!==formulaText?formulaText[0]===FORMULA_INDICATOR:!1},idr.workbook.Runtime.prototype.getDependenciesNames=function(cell){var depsResult=[];if(this.isFormula(cell.FormulaText)){var cellArray=this.removeCellDecorators(cell.FormulaText).match(RegExp(CELL_NAME_REGEX,"g"));null!==cellArray&&(depsResult=cellArray);var rangeArray=this.removeCellDecorators(cell.FormulaText).match(RegExp(RANGE_NAME_REGEX,"g"));if(null!==rangeArray)for(var i in rangeArray)depsResult=depsResult.concat(this.expandRangeToCellNameArray(rangeArray[i]));depsResult=depsResult.filter(function(elem,pos,self){return self.indexOf(elem)===pos})}return depsResult},idr.workbook.Runtime.prototype.expandRangeToCellNameArray=function(rangeName){var validRange=this.validateRangeName(rangeName),cellNameArray=[];if(null!==validRange){var startRowCol=this.cellNameToRowColumn(validRange[1]),endRowCol=this.cellNameToRowColumn(validRange[4]);if(null!==startRowCol&&null!==endRowCol)for(var startRow=startRowCol.row<endRowCol.row?startRowCol.row:endRowCol.row,startColumn=startRowCol.column<endRowCol.column?startRowCol.column:endRowCol.column,r=0;r<=Math.abs(startRowCol.row-endRowCol.row);r++)for(var c=0;c<=Math.abs(startRowCol.column-endRowCol.column);c++)cellNameArray.push(this.rowColumnToCellName(r+startRow,c+startColumn))}return cellNameArray},idr.workbook.Runtime.prototype.expandRangeToCellNameMatrix=function(rangeName){var validRange=this.validateRangeName(rangeName),cellNameMatrix=[];if(null!==validRange){var startRowCol=this.cellNameToRowColumn(validRange[1]),endRowCol=this.cellNameToRowColumn(validRange[4]);if(null!==startRowCol&&null!==endRowCol)for(var startRow=startRowCol.row<endRowCol.row?startRowCol.row:endRowCol.row,startColumn=startRowCol.column<endRowCol.column?startRowCol.column:endRowCol.column,r=0;r<=Math.abs(startRowCol.row-endRowCol.row);r++){cellNameMatrix.push([]);for(var c=0;c<=Math.abs(startRowCol.column-endRowCol.column);c++)cellNameMatrix[r].push(this.rowColumnToCellName(r+startRow,c+startColumn))}}return cellNameMatrix},idr.workbook.Runtime.prototype.removeCellDecorators=function(cellName){var result=cellName,regexp=new RegExp(CELL_NAME_REGEX,"g"),result=result.replace(regexp,function($0){return $0.replace(RegExp(DECORATOR_ABSOLUTE_REF_REGEX,"g"),"")});return result},idr.workbook.Runtime.prototype.evaluateCell=function(cell){this.evalNode(cell)},idr.workbook.Runtime.prototype.evalNode=function(cell){cell.Formula="";var deps=cell.getDependencies();for(var d in deps){var cellDep=deps[d];if(0!==cellDep.Error){cell.setError(cellDep.Error,cellDep.Value);break}var depFormula="var "+cellDep.Name+"=";depFormula+=cellDep.Type===idr.workbook.Cell.TYPE_STRING?"'"+idr.workbook.Runtime.encodeChars(cellDep.Value)+"'":cellDep.Value,cell.Formula+=depFormula+";",cell.setError(0,null)}cell.Formula+=this.generateJavascriptFromCell(cell),this.evaluateJavascriptFromCell(cell),cell.NeedEvaluate=!1},idr.workbook.Runtime.prototype.evaluateJavascriptFromCell=function(cell){try{if(-1!==cell.Formula.indexOf(idr.workbook.RuntimeBase.ERROR_IN_DEPENDENCY))cell.setError(1,idr.workbook.RuntimeBase.ERROR_IN_DEPENDENCY),cell.Formula=this.generateJavascriptFromCell(cell);else if(cell.Value=eval(cell.Formula+cell.Name),cell.Type===idr.workbook.Cell.TYPE_STRING)try{cell.Value=decodeURI(cell.Value)}catch(de){console.log("cell value decode error")}}catch(e){cell.setError(1,idr.workbook.RuntimeBase.ERROR_IN_VALUE),cell.Formula=this.generateJavascriptFromCell(cell)}return cell.Value},idr.workbook.Runtime.prototype.generateJavascriptFromCell=function(cell){var jsResult="";if(null!==cell.FormulaText)if(0!==cell.Error)jsResult="var "+cell.Name+"='"+cell.Value+"';";else{var cellValue=cell.FormulaText;"string"==typeof cellValue&&(this.isFormula(cellValue)?(cellValue=this.removeCellDecorators(cellValue),cellValue=this.generateJavascriptFormula(cellValue.substr(cellValue.indexOf("=")+1))):cellValue="'"+idr.workbook.Runtime.encodeChars(cellValue)+"'"),jsResult="var "+cell.Name+"="+cellValue+";"}return jsResult},idr.workbook.Runtime.prototype.generateJavascriptFormula=function(strFormula){var strResult=strFormula,pattern=RegExp(FORMULA_REGEX,"g");return strResult=strResult.replace(pattern,function($0,$1){return FORMULA_NAMESPACE_PREFIX+$1+"("}),strResult=this.replaceRangeNameByCellsName(strResult)},idr.workbook.Runtime.prototype.replaceRangeNameByCellsName=function(strFormula){var matchArray=strFormula.match(RegExp(RANGE_NAME_REGEX,"g")),result=strFormula;if(null!==matchArray)for(var i in matchArray){var cells=this.expandRangeToCellNameArray(matchArray[i]),strCells="";for(var c in cells)strCells+=cells[c],cells.length-1!=c&&(strCells+=",");result=result.replace(matchArray[i],strCells)}return result},idr.workbook.Runtime.prototype.calculateFormulaWithOffset=function(formulaText,offsetRowCol){var self=this;if(!this.isFormula(formulaText))return formulaText;var pattern=RegExp(CELL_NAME_REGEX,"g"),strFormulaTextResult=formulaText;return strFormulaTextResult=strFormulaTextResult.replace(pattern,function($0){var newCellName=self.calculateCellName($0,offsetRowCol);return newCellName})},idr.workbook.Runtime.prototype.calculateFormulaOrRangeWithOffset=function(formulaText,offsetRowCol){var strFormulaTextResult=formulaText,validRange=this.validateRangeName(formulaText);if(validRange){var cellNameFrom=this.validateRangeName(formulaText)[1],cellNameTo=this.validateRangeName(formulaText)[4];cellNameFrom=this.calculateCellName(cellNameFrom,offsetRowCol),cellNameTo=this.calculateCellName(cellNameTo,offsetRowCol),strFormulaTextResult=cellNameFrom+":"+cellNameTo}else strFormulaTextResult=this.calculateFormulaWithOffset(formulaText,offsetRowCol);return strFormulaTextResult},idr.workbook.Runtime.encodeChars=function(str){return encodeURI(str).replace(/'/g,"%27")},idr.workbook.Runtime.prototype.calculateCellName=function(cellName,offsetRowCol){var cellLetterNumber=this.cellNameToLetterNumber(cellName);if(null===cellLetterNumber)return cellName;var letter=this.sumLetter(cellLetterNumber.letter,offsetRowCol.column),number=this.sumNumber(cellLetterNumber.number,offsetRowCol.row);return null===letter||null===number?idr.workbook.RuntimeBase.ERROR_IN_DEPENDENCY:letter+number},idr.workbook.Runtime.prototype.sumLetter=function(letter,number){var letterName=null;if(void 0===letter||null===letter||void 0===number||null===number)return null;if("string"!=typeof letter||"number"!=typeof number)return null;var LetterNumberSum=number+letter.charCodeAt(0)-65;if(letter[0]===ABSOLUTE_REF_DECORATOR)return letter;if(LetterNumberSum>=0){var letterNumber=Math.floor(LetterNumberSum/26);letterName=letterNumber>0?String.fromCharCode(letterNumber-1+65)+String.fromCharCode(LetterNumberSum%26+65):String.fromCharCode(LetterNumberSum+65)}return letterName},idr.workbook.Runtime.prototype.sumNumber=function(strNumber,n){if(void 0===strNumber||null===strNumber||void 0===n||null===n)return null;if("string"!=typeof strNumber||"number"!=typeof n)return null;if("string"==typeof strNumber){if(strNumber[0]===ABSOLUTE_REF_DECORATOR)return strNumber;var number=parseInt(strNumber,10);if(!isNaN(number)){var numberResult=number+n;if(numberResult>0)return numberResult.toString()}}return null},idr.workbook.Runtime.prototype.normalizeFormulaText=function(formulaText){var strFormulaTextResult=formulaText;if(this.isFormula(formulaText)){var formulaPattern=RegExp(FORMULA_REGEX,"g");strFormulaTextResult=strFormulaTextResult.replace(formulaPattern,function($0){var newCellName=$0.toUpperCase();return newCellName});var cellPattern=RegExp(CELL_NAME_REGEX,"g");strFormulaTextResult=strFormulaTextResult.replace(cellPattern,function($0){var newCellName=$0.toUpperCase();return newCellName})}return strFormulaTextResult},idr.workbook.Runtime.prototype.getCellNamesFromRowColumn=function(rowColumn){var rcFrom={row:rowColumn[0],column:rowColumn[1]},rcTo={row:rowColumn[2],column:rowColumn[3]},rangeName=this.rowColumnToRangeName(rcFrom,rcTo);return this.expandRangeToCellNameArray(rangeName)},idr.workbook.Runtime.prototype.cellArrayToRange=function(cellArray){for(var minorRowCol={row:"",column:""},majorRowCol={row:"",column:""},rangeName="",range=null,i=0;i<cellArray.length;i++){var rowCol=this.cellNameToRowColumn(cellArray[i].Name),row=rowCol.row,col=rowCol.column;0===i&&(minorRowCol.row=rowCol.row,minorRowCol.column=rowCol.column,majorRowCol.row=rowCol.row,majorRowCol.column=rowCol.column),minorRowCol.row=row<minorRowCol.row?row:minorRowCol.row,minorRowCol.column=col<minorRowCol.column?col:minorRowCol.column,majorRowCol.row=row>majorRowCol.row?row:majorRowCol.row,majorRowCol.column=col>majorRowCol.column?col:majorRowCol.column}return""!==minorRowCol.row&&""!==minorRowCol.column&&""!==majorRowCol.row&&""!==majorRowCol.column&&(rangeName=this.rowColumnToRangeName(minorRowCol,majorRowCol),range=new idr.workbook.DefaultRange(rangeName)),range},idr.workbook.Runtime.prototype.removeBinderCellsFromArray=function(cellArray){for(var cleanArray=[],i=0;i<cellArray.length;i++){var cell=cellArray[i],row=this.cellNameToRowColumn(cell.Name).row;row<idr.workbook.Runtime.MAX_USER_ROWS&&cleanArray.push(cell)}return cleanArray};