/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.workbook.WorkbookView"),goog.require("idr.workbook.WorkbookToolbarView"),goog.require("idr.workbook.DefaultRange"),goog.require("goog.structs.Map"),goog.require("idr.debug");var DEFAULT_WORKSHEET_NAME="default",MAX_COLUMNS=50,DEFAULT_COLUMN_SIZE=80;idr.workbook.WorkbookView=function(controller){this._handsontable=null,this._currentSelection=[],this._controller=controller,this._$gridContainer=null,this._$formulaBarInput=null,this.workbookViewWidth=300,this.workbookViewHeight=400,this.workbookTopHeightConstraint=14,this._workbookViewDiv=null,this._componentToolbar=null,this._componentToolbarPlaceholder=null,this._maxRows=this._controller._workbook._runtime.getMaxUserRows(),this._preventFocus=!1,this._currentColumnsWidths={},this._workbook=this._controller.workbook(),this._spreadsheetTableBodyRoot=null,this._firstVisibleRowHeader=null,this._onetimeCallbacks={toolbarItemSelected:{callback:null,arguments:[]}},this.initializeView()},idr.workbook.WorkbookView.prototype.setFocus=function(value){if(this._preventFocus=!value,value){var coordinates=this.coordinatesForToolbar();this._componentToolbar.show(coordinates)}else this._componentToolbar.hide()},idr.workbook.WorkbookView.prototype.initializeView=function(){this._workbookViewDiv=$('<div id="workbook" style="padding: 0;">   <div id="grid" style="overflow: scroll;"></div></div>'),this._componentToolbarPlaceholder=$('<div id="workbook-floating-toolbar" class="xdk-floating-toolbar floating-toolbar"></div>');var toolbarParentDiv=this._controller.baseView();$(toolbarParentDiv).append(this._componentToolbarPlaceholder)},idr.workbook.WorkbookView.prototype.clean=function(){this._handsontable.loadData=[]},idr.workbook.WorkbookView.prototype.initialize=function(onreadyCallback){var self=this;this._$gridContainer=$("div#grid");var onBeforeChange=function(changes){self.setCellsToWorksheet(DEFAULT_WORKSHEET_NAME,changes)},cellRenderer=function(instance,td,row,col,prop,value){Handsontable.renderers.TextRenderer.apply(this,arguments),null!==value&&self._controller._workbook.styleCell(DEFAULT_WORKSHEET_NAME,row,col,td)};if(0!==this._$gridContainer.length){$(this._$gridContainer).handsontable({startRows:100,maxRows:this._maxRows,startCols:MAX_COLUMNS,colWidths:this.getColumnsWidths(),minSpareRows:5,colHeaders:!0,rowHeaders:!0,enterBeginsEditing:!1,outsideClickDeselects:!1,contextMenu:!1,manualColumnResize:!0,stretchH:"all",width:function(){return self.workbookViewWidth},height:function(){return self.workbookViewHeight},beforeChange:onBeforeChange,workbookRuntime:this._controller._workbook,cells:function(){this.renderer=cellRenderer},afterColumnResize:function(col,size){self._currentColumnsWidths[col]=size}}),this._handsontable=$(this._$gridContainer).handsontable("getInstance"),this._$gridContainer.on("dragover",function(){window.event.preventDefault&&window.event.preventDefault(),window.event.stopPropagation?window.event.stopPropagation():window.event.cancelBubble=!0;var target=$(window.event.target);return $("#workbook #grid td.dragover").removeClass("dragover"),target&&target.is("td")&&target.addClass("dragover"),!1}),this._spreadsheetTableBodyRoot=$(this._$gridContainer).find("div.wtSpreader").find("tbody")[0],this._$gridContainer.on("drop",function(){window.event.preventDefault&&window.event.preventDefault(),window.event.stopPropagation?window.event.stopPropagation():window.event.cancelBubble=!0;var dropText=window.event.dataTransfer.getData("Text"),jqtarget=(window.event.toElement,$(window.event.target)),tr=jqtarget.closest("tr"),row=(jqtarget.closest("tbody"),parseInt(tr.find("th").text(),10)-1),spreadsheetTableBodyRoot=self._spreadsheetTableBodyRoot,firstVisibleColumnHeader=spreadsheetTableBodyRoot.previousSibling.childNodes[0].childNodes[1].childNodes[0].childNodes[0],firstVisibleColumn=self._workbook.cellNameToRowColumn(firstVisibleColumnHeader.innerText+"1").column,col=tr.children().index(jqtarget)-1+firstVisibleColumn;return self.setCellToWorksheet(DEFAULT_WORKSHEET_NAME,row,col,dropText),!1}),this._handsontable.addHook("beforeEdit",function(r,c){var cell=self.getCellFromWorksheet(DEFAULT_WORKSHEET_NAME,r,c);return null!==cell?cell.FormulaText+"":void idr.debug.log("NULL")}),this._handsontable.addHook("onCellTextChange",function(value){self._componentToolbar.updateFormula(value)}),this._handsontable.addHook("afterSelection",function(r,c,r2,c2){if(r>r2){var rt=r;r=r2,r2=rt}if(c>c2){var ct=c;c=c2,c2=ct}self._currentSelection=[r,c,r2,c2];var cell=self.getCellFromWorksheet(DEFAULT_WORKSHEET_NAME,r,c),cellFormulaVale=null!==cell?cell.FormulaText:"";self.getWorkbook().setCurrentCell(cell),self._componentToolbar.updateFormula(cellFormulaVale);var rangeStr=self._workbook.rowColumnToRangeName({row:r,column:c},{row:r2,column:c2});$(self).trigger("selectionChange",[rangeStr,self._currentSelection])}),this._handsontable.addHook("beforeKeyDown",function(event){self._preventFocus&&event.stopImmediatePropagation()}),this._controller._workbook.addWorksheetChangedCallback(function(event,worksheetName,cells){var changes=[];self._handsontable.removeHook("beforeChange",onBeforeChange);for(var i in cells){var cell=cells[i],rowcol=self._controller._workbook._runtime.cellNameToRowColumn(cell.Name);if(rowcol.row<self._maxRows){var cellData=[rowcol.row,rowcol.column,cell.getFormatedValue()];changes.push(cellData)}}0!==changes.length&&self._handsontable.setDataAtCell(changes),self._handsontable.addHook("beforeChange",onBeforeChange)}),this._controller._workbook.addWorksheetRenderChangedCallback(function(){self._handsontable.render()});var toolbarParentDiv=this._controller.baseView();this._componentToolbar=new idr.workbook.WorkbookToolbarView(this,this._componentToolbarPlaceholder,toolbarParentDiv,this._controller),this._componentToolbar.initializeView(this._controller._workbook,null),$(this._componentToolbar).on("item-selected",function(event,toolbarDataItem){var args=self._onetimeCallbacks.toolbarItemSelected.arguments;(0===args.length||1===args.length&&args[0]===toolbarDataItem.key)&&self.checkOneTimeCallback(self._onetimeCallbacks.toolbarItemSelected)});var parentDiv=$(this._workbookViewDiv).parent();this.resize(parentDiv.width(),parentDiv.height()-this.workbookTopHeightConstraint)}onreadyCallback instanceof Function&&onreadyCallback()},idr.workbook.WorkbookView.prototype.setCellToWorksheet=function(worksheetName,row,col,cellFormulaText){var cellName=this._controller._workbook._runtime.rowColumnToCellName(row,col),cell=this._controller._workbook.setCellToWorksheet(worksheetName,cellName,cellFormulaText);return idr.debug.log(null!==cell?"Cell created: "+cell.Name+" - "+cell.Value+" - "+cell.getFormatedValue():"Unable to create the cell"),cell},idr.workbook.WorkbookView.prototype.setCellsToWorksheet=function(worksheetName,data){return this._controller.setCells(worksheetName,data)},idr.workbook.WorkbookView.prototype.getCellFromWorksheet=function(worksheetName,row,col){var cellName=this._controller._workbook._runtime.rowColumnToCellName(row,col),cell=this._controller._workbook.getCellFromWorksheet(worksheetName,cellName);return cell},idr.workbook.WorkbookView.prototype.resize=function(width,height){if(this.workbookViewWidth=width,this.workbookViewHeight=height,this._$gridContainer.handsontable("updateSettings",{width:this.workbookViewWidth,height:this.workbookViewHeight,colWidths:this.getColumnsWidths()}),this._componentToolbar.isVisible()){var coordinates=this.coordinatesForToolbar();this._componentToolbar.updatePosition(coordinates)}},idr.workbook.WorkbookView.prototype.workbookView=function(){return this._workbookViewDiv},idr.workbook.WorkbookView.prototype.getWorkbook=function(){return this._controller._workbook},idr.workbook.WorkbookView.prototype.highligthFormula=function(formulaText,colors){if("string"==typeof formulaText&&(formulaText=formulaText.trim(),void 0!==formulaText&&formulaText.length>1)){formulaText=formulaText.toUpperCase().trim();var cellPattern=/[a-z][a-z]?[0-9]+(:[a-z][a-z]?[0-9]+)?/gi,results=formulaText.match(cellPattern);if(null!==results)for(var i=0;i<results.length;i++){var cells=results[i],index=cells.indexOf(":");cells=index>-1?cells.split(":"):[cells,cells];var start=this._workbook.cellNameToRowColumn(cells[0]),end=this._workbook.cellNameToRowColumn(cells[1]);this.highlightCells(start.row,start.column,end.row,end.column,colors)}}},idr.workbook.WorkbookView.prototype.unhighlightFormula=function(formulaText){this.highligthFormula(formulaText,{border:"",background:""})},idr.workbook.WorkbookView.prototype.highlightCells=function(row,column,endRow,endColumn,colors){try{var r,c,element,firstVisibleRow,firstVisibleColumn,firstVisibleColumnHeader,borderStr="1px dashed red",backgroundColor="rgb(255, 229, 229)";void 0!==colors&&(borderStr=colors.border,backgroundColor=colors.background);var spreadsheetTableBodyRoot=this._spreadsheetTableBodyRoot;firstVisibleColumnHeader=spreadsheetTableBodyRoot.previousSibling.childNodes[0].childNodes[1].childNodes[0].childNodes[0],this._firstVisibleRowHeader=spreadsheetTableBodyRoot.childNodes[0].childNodes[0],firstVisibleRow=parseInt(this._firstVisibleRowHeader.innerText,10)-1,firstVisibleColumn=this._workbook.cellNameToRowColumn(firstVisibleColumnHeader.innerText+"1").column;var maxVisibleColumn=firstVisibleColumn+spreadsheetTableBodyRoot.childNodes[0].childNodes.length;if(column>maxVisibleColumn)return;if(endColumn>maxVisibleColumn&&(endColumn=maxVisibleColumn),firstVisibleRow>endRow)return;if(firstVisibleColumn>endColumn)return;for(row-=firstVisibleRow,0>row&&(row=0),endRow-=firstVisibleRow,column-=firstVisibleColumn,0>column&&(column=0),endColumn-=firstVisibleColumn,c=column;endColumn>=c;c++)row>0?spreadsheetTableBodyRoot.childNodes[row-1]&&(element=spreadsheetTableBodyRoot.childNodes[row-1].childNodes[c+1],element.style.borderBottom=borderStr):spreadsheetTableBodyRoot.childNodes[row]&&(element=spreadsheetTableBodyRoot.childNodes[row].childNodes[c+1],element.style.borderTop=borderStr),spreadsheetTableBodyRoot.childNodes[endRow]&&(element=spreadsheetTableBodyRoot.childNodes[endRow].childNodes[c+1],element.style.borderBottom=borderStr);for(r=row;endRow>=r;r++)spreadsheetTableBodyRoot.childNodes[r]&&(element=spreadsheetTableBodyRoot.childNodes[r].childNodes[column],element.style.borderRight=borderStr,element=spreadsheetTableBodyRoot.childNodes[r].childNodes[endColumn+1],element.style.borderRight=borderStr);for(r=row;endRow>=r;r++)for(c=column;endColumn>=c;c++)spreadsheetTableBodyRoot.childNodes[r]&&(element=spreadsheetTableBodyRoot.childNodes[r].childNodes[c+1],""!==backgroundColor?(element.dataset.oldBC=element.style.backgroundColor,element.style.backgroundColor=backgroundColor):element.style.backgroundColor=void 0!==element.dataset.oldBC&&""!==element.dataset.oldBC?element.dataset.oldBC:backgroundColor)}catch(error){}},idr.workbook.WorkbookView.prototype.solveNameToSelector=function(mainName,subName,options){var selector="",iframe=null;return"workbook"!==mainName?null:(selector="#workbook","header"===subName?selector="#workbook #grid thead":"toolbar"===subName&&(selector=""===options?"#workbook-floating-toolbar":'#workbook-floating-toolbar .toolbar-item[data-key="'+options+'"]',this.setFocus(!0),iframe=""),{iframe:iframe,selector:selector})},idr.workbook.WorkbookView.prototype.listenOneTimeEvent=function(itemName,eventName,args,callback){var callbackData={callback:callback,arguments:args};"workbook"===itemName&&"toolbar-item-selected"===eventName&&(this._onetimeCallbacks.toolbarItemSelected=callbackData)},idr.workbook.WorkbookView.prototype.checkOneTimeCallback=function(onetimeEventObject){"function"==typeof onetimeEventObject.callback&&(onetimeEventObject.callback(),onetimeEventObject.callback=null,onetimeEventObject.arguments=[])},idr.workbook.WorkbookView.prototype.getColumnsWidths=function(){for(var result=[],i=0;MAX_COLUMNS>i;i++){var colSize=DEFAULT_COLUMN_SIZE;this._currentColumnsWidths&&this._currentColumnsWidths[i]&&(colSize=this._currentColumnsWidths[i]),result.push(colSize)}return result},idr.workbook.WorkbookView.prototype.update=function(){this._$gridContainer.handsontable("updateSettings",{colWidths:this.getColumnsWidths()})},idr.workbook.WorkbookView.prototype.loadFromJson=function(jsonObj){if(this._currentColumnsWidths={},"object"==typeof jsonObj&&jsonObj.worksheets&&jsonObj.worksheets instanceof Array&&jsonObj.worksheets.length>0){var worksheet=jsonObj.worksheets[0];this._currentColumnsWidths=worksheet.colwidths}this.update()},idr.workbook.WorkbookView.prototype.updateFromJson=function(jsonObj,offsetRowCol){if("object"==typeof jsonObj&&jsonObj.worksheets&&jsonObj.worksheets instanceof Array&&jsonObj.worksheets.length>0){var worksheet=jsonObj.worksheets[0],colwidths={};colwidths=offsetRowCol?this.offsetColWidth(worksheet.colwidths,offsetRowCol):worksheet.colwidths;for(var columns=Object.keys(colwidths),i=0;i<columns.length;i++)this._currentColumnsWidths[columns[i]]=colwidths[columns[i]]}this.update()},idr.workbook.WorkbookView.prototype.toJson=function(){var worksheets=[];return worksheets.push({worksheet:"default"}),worksheets[0].colwidths=this._currentColumnsWidths,{worksheets:worksheets}},idr.workbook.WorkbookView.prototype.offsetColWidth=function(colWidth,offsetRowCol){var colOffset=0;offsetRowCol&&offsetRowCol.column&&(colOffset=offsetRowCol.column);var returnColWidth={};if(colWidth&&"object"==typeof colWidth)for(var cols=Object.keys(colWidth),i=0;i<cols.length;i++){var col=cols[i];returnColWidth[parseInt(col,10)+colOffset]=colWidth[col]}return returnColWidth},idr.workbook.WorkbookView.prototype.coordinatesForToolbar=function(){var baseOffset=this._controller.baseOffset(),y=this._workbookViewDiv.offset().top-30+baseOffset.top,x=baseOffset.left+5;return{x:x,y:y}},idr.workbook.WorkbookView.prototype.closeEdition=function(){this._handsontable.destroyEditor()};