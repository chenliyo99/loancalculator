/**
 * @license Copyright 2013 - 2014 Intel Corporation All Rights Reserved.
 *
 * The source code, information and material ("Material") contained herein is owned by Intel Corporation or its
 * suppliers or licensors, and title to such Material remains with Intel Corporation or its suppliers or
 * licensors. The Material contains proprietary information of Intel or its suppliers and licensors. The
 * Material is protected by worldwide copyright laws and treaty provisions. No part of the Material may be used,
 * copied, reproduced, modified, published, uploaded, posted, transmitted, distributed or disclosed in any way
 * without Intel's prior express written permission. No license under any patent, copyright or other intellectual
 * property rights in the Material is granted to or conferred upon you, either expressly, by implication,
 * inducement, estoppel or otherwise. Any license under such intellectual property rights must be express and
 * approved by Intel in writing.
 *
 * Unless otherwise agreed by Intel in writing, you may not remove or alter this notice or any other notice
 * embedded in Materials by Intel or Intel's suppliers or licensors in any way.
 */
goog.provide("idr.workbook.Worksheet"),goog.require("goog.structs.Map"),goog.require("idr.workbook.Cell"),goog.require("idr.workbook.Runtime"),goog.require("idr.workbook.CellFormat"),goog.require("idr.workbook.CellStyle"),goog.require("idr.workbook.DefaultRange"),idr.workbook.Worksheet=function(name,runtime,parent){idr.debug.assertRequireParameter(name,"name"),idr.debug.assertRequireParameter(runtime,"runtime"),this._name=name,this._active=!1,this._cells=new goog.structs.Map,this._runtime=void 0===runtime?null:runtime,this._parent=void 0===parent?null:parent},idr.workbook.Worksheet.INVALID_NAME_FOR_WORKSHEET_EXCEPTION="invalidNameForWorksheetException",idr.workbook.Worksheet.CELL_NOT_FOUND_EXCEPTION="cellNotFoundException",idr.workbook.Worksheet.INVALID_CELL_NAME_EXCEPTION="invalidCellNameException",Object.defineProperty(idr.workbook.Worksheet.prototype,"Name",{get:function(){return this._name},set:function(name){this._name=name}}),Object.defineProperty(idr.workbook.Worksheet.prototype,"Active",{get:function(){return this._active},set:function(active){this._active=active}}),idr.workbook.Worksheet.prototype.setCell=function(cellName,cellFormula){var cell=null;return cellName=this._runtime.normalizeCellName(cellName),null!==this._runtime&&this._runtime.validateCellName(cellName)&&(cell=this.getCell(cellName),null!==cell?(cell.clean(),cell.FormulaText=cellFormula):(cell=new idr.workbook.Cell(cellName,cellFormula,this._runtime,this),this._cells.set(cell.Name,cell)),cell.hasFormat()||idr.workbook.CellFormat.applyInitialFormat(cell)),cell},idr.workbook.Worksheet.prototype.setCellByCopy=function(cellName,cellFormula,format,style){var cell=this.getCell(cellName),data={};data=null!==cell?{name:cell.Name,formulaText:cell.FormulaText,format:format?format.toJson():"",style:style?style.toJson():""}:{name:cellName,formulaText:"",format:"",style:""};var interactionData={type:"CELL_VALUE",data:JSON.stringify(data)};idr.core.Editor&&idr.core.Editor.instance&&idr.core.Editor.instance._actionsController.pushIntoHistory(this,interactionData);var newCell=this.setCell(cellName,cellFormula);return null!==newCell&&(idr.workbook.CellFormat.copyFormat(newCell,format),idr.workbook.CellStyle.copyStyle(newCell,style)),newCell},idr.workbook.Worksheet.prototype.undoHistoryRequested=function(interactionData){idr.debug.log(interactionData.toString());var data=JSON.parse(interactionData.data),cell=this.setCell(data.name,data.formulaText);return null!==cell&&(idr.workbook.CellFormat.copyFormat(cell,data.format),idr.workbook.CellStyle.copyStyle(cell,data.style)),cell},idr.workbook.Worksheet.prototype.redoHistoryRequested=function(interactionData){idr.debug.log(interactionData.toString())},idr.workbook.Worksheet.prototype.setCellFormat=function(cellName,formatType,formatExpression){var cell=this.getOrCreateCell(cellName);return idr.workbook.CellFormat.addFormatToCell(cell,formatType,formatExpression),cell},idr.workbook.Worksheet.prototype.applyCellStyle=function(cellName,markup){if(this._runtime&&this._runtime.validateCellName(cellName)){var cell=this.getCell(cellName);cell&&cell.applyStyle&&cell.applyStyle(markup)}},idr.workbook.Worksheet.prototype.setCellsFontStyle=function(cellName,fontStyle,value){var cell=this.getOrCreateCellWithStyle(cellName);cell.CellStyle.setFontStyle(fontStyle,value)},idr.workbook.Worksheet.prototype.setCellsBackground=function(cellName,color){var cell=this.getOrCreateCellWithStyle(cellName);cell.CellStyle.setColor(idr.workbook.CellStyle.ColorType.BACKGROUND,color)},idr.workbook.Worksheet.prototype.setCellsFontColor=function(cellName,color){var cell=this.getOrCreateCellWithStyle(cellName);cell.CellStyle.setColor(idr.workbook.CellStyle.ColorType.VALUE,color)},idr.workbook.Worksheet.prototype.setCellsFontSize=function(cellName,size){var cell=this.getOrCreateCellWithStyle(cellName);cell.CellStyle.FontSize=size},idr.workbook.Worksheet.prototype.setCellsFontFamily=function(cellName,family){var cell=this.getOrCreateCellWithStyle(cellName);cell.CellStyle.FontFamily=family},idr.workbook.Worksheet.prototype.setCellsAlignment=function(cellName,alignment){var cell=this.getOrCreateCellWithStyle(cellName);cell.CellStyle.TextAlign=alignment},idr.workbook.Worksheet.prototype.getCell=function(cellName){cellName=this._runtime.normalizeCellName(cellName);var cell=this._cells.get(cellName);return void 0===cell?null:cell},idr.workbook.Worksheet.prototype.getOrCreateCell=function(cellName){var cell=null;return null!==this._runtime&&this._runtime.validateCellName(cellName)&&(cell=this.getCell(cellName),null===cell&&(cell=new idr.workbook.Cell(cellName,"",this._runtime,this),this._cells.set(cellName,cell))),cell},idr.workbook.Worksheet.prototype.getOrCreateCellWithStyle=function(cellName){var cell=this.getOrCreateCell(cellName);return null===cell||cell.hasStyle()||(cell.CellStyle=new idr.workbook.CellStyle),cell},idr.workbook.Worksheet.prototype.getCellsByRange=function(rangeName,createIfNotExists){rangeName=rangeName.toUpperCase();var cellsName=[],cells=[];if(null!==this._runtime&&this._runtime.validateRangeName(rangeName)){cellsName=this._runtime.expandRangeToCellNameArray(rangeName);for(var i in cellsName){var cell=this.getCell(cellsName[i]);null===cell&&createIfNotExists&&(cell=this.setCell(cellsName[i],"")),cell&&cells.push(cell)}}return cells},idr.workbook.Worksheet.prototype.setCellsByRange=function(rangeName,defaultFormulaText,data){var cellsName=[],cells=[],dataParam=void 0!==data&&null!==data?data:[],range=new idr.workbook.DefaultRange(rangeName);if(null!==this._runtime&&range.isValid()){cellsName=this._runtime.expandRangeToCellNameArray(rangeName);for(var i in cellsName){var rowCol=range.getRelativeRowCol(cellsName[i]);if(null!==rowCol){var dataArray=dataParam[rowCol.row],formulaText=void 0!==dataArray&&null!==dataArray&&void 0!==dataArray[rowCol.column]?dataArray[rowCol.column]:defaultFormulaText;cells.push(this.setCell(cellsName[i],formulaText))}}}return cells},idr.workbook.Worksheet.prototype.setCellsByArray=function(cellsArray){var cells=[];for(var i in cellsArray){var name=cellsArray[i].Name,formulaText=void 0!==cellsArray[i].FormulaText&&null!==cellsArray[i].FormulaText?cellsArray[i].FormulaText:"";if(void 0!==name&&null!==name){var cell=this.setCell(name,formulaText);cell.loadFromJson(cellsArray[i]),cells.push(cell)}}return cells},idr.workbook.Worksheet.prototype.setCellsByString=function(toCellOrRangeName,strData){var toCellName=null,numberRegex=new RegExp("^(\\d+)?\\.?(\\d+)?$");null!==this._runtime.validateCellName(toCellOrRangeName)?toCellName=toCellOrRangeName:null!==this._runtime.validateRangeName(toCellOrRangeName)&&(toCellName=this._runtime.expandRangeToCellNameArray(toCellOrRangeName)[0]);var cells=[],rows=strData.split("\n");for(var r in rows){var cols=rows[r].split("	");for(var c in cols){var cellName=this._runtime.calculateCellName(toCellName,{row:parseInt(r,10),column:parseInt(c,10)}),value=cols[c];""!==value.trim()&&numberRegex.test(cols[c])&&(value=parseFloat(cols[c])),cells.push(this.setCell(cellName,value))}}return cells},idr.workbook.Worksheet.prototype.setCellsByCopy=function(fromCellOrRangeName,toCellOrRangeName,copyType){var fromCellsName=[];null!==this._runtime.validateCellName(fromCellOrRangeName)?fromCellsName.push(fromCellOrRangeName):null!==this._runtime.validateRangeName(fromCellOrRangeName)&&(fromCellsName=this._runtime.expandRangeToCellNameArray(fromCellOrRangeName));var toCellsName=[];null!==this._runtime.validateCellName(toCellOrRangeName)?toCellsName.push(toCellOrRangeName):null!==this._runtime.validateRangeName(toCellOrRangeName)&&(toCellsName=this._runtime.expandRangeToCellNameArray(toCellOrRangeName),fromCellsName.length>1&&(toCellsName=toCellsName.slice(0,1)));var cells=[];if(0!==fromCellsName.length&&0!==toCellsName.length)for(var t in toCellsName){var fromRowCol=this._runtime.cellNameToRowColumn(fromCellsName[0]),toRowCol=this._runtime.cellNameToRowColumn(toCellsName[t]),offsetRowCol={};offsetRowCol.row=toRowCol.row-fromRowCol.row,offsetRowCol.column=toRowCol.column-fromRowCol.column;for(var i in fromCellsName){var name=this._runtime.calculateCellName(fromCellsName[i],offsetRowCol),copyCell=this.getCell(fromCellsName[i]);if(void 0!==name&&null!==name){var formulaText="",cellFormat=null,cellStyle=null;if(null!==copyCell&&void 0!==copyCell)switch(copyType){case idr.workbook.Workbook.COPY_TYPE.values:formulaText=void 0!==copyCell.Value&&null!==copyCell.Value?copyCell.Value:"";break;case idr.workbook.Workbook.COPY_TYPE.functions:formulaText=void 0!==copyCell.FormulaText&&null!==copyCell.FormulaText?this._runtime.calculateFormulaWithOffset(copyCell.FormulaText,offsetRowCol):"",cellFormat=copyCell.CellFormat,cellStyle=copyCell.CellStyle;break;case idr.workbook.Workbook.COPY_TYPE.links:formulaText="="+copyCell.Name;break;default:formulaText=""}cells.push(this.setCellByCopy(name,formulaText,cellFormat,cellStyle))}}}return cells},idr.workbook.Worksheet.prototype.getCells=function(){return this._cells.getValues()},idr.workbook.Worksheet.prototype.unsetCell=function(cellName){var cell=this._cells.get(cellName);null!==cell&&void 0!==cell&&this._cells.remove(cellName)},idr.workbook.Worksheet.prototype.getFreeRange=function(rows,cols){for(var MAX_ROW=19,MAX_COLUMN=100,r=0;MAX_ROW>r;r++)for(var c=0;MAX_COLUMN>c;c++)if(this.isFreeRange(r,c,rows,cols)){var rangeName=this._runtime.rowColumnToCellName(r,c)+":"+this._runtime.rowColumnToCellName(r+rows-1,c+cols-1),range=new idr.workbook.DefaultRange(rangeName);return range}return null},idr.workbook.Worksheet.prototype.isFreeRange=function(row,column,rowCount,columnCount){for(var r=row;row+rowCount>r;r++)for(var c=column;column+columnCount>c;c++){var cellName=this._runtime.rowColumnToCellName(r,c);if(void 0!==this._cells.get(cellName))return!1}return!0},idr.workbook.Worksheet.prototype.onCellsChanged=function(cells){this.notifyChangeToParent(cells)},idr.workbook.Worksheet.prototype.notifyChangeToParent=function(cells){null!==this._parent&&this._parent.onWorksheetChanged(this._name,cells,"data")},idr.workbook.Worksheet.prototype.toJson=function(){var worksheetJson={worksheet:this.Name,cells:[]},cellsNames=this._cells.getKeys();for(var i in cellsNames){var cell=this._cells.get(cellsNames[i]),jsonObj=cell.toJson();worksheetJson.cells.push(jsonObj)}return worksheetJson},idr.workbook.Worksheet.prototype.setCellsByCopyToFreeRange=function(cellsArray){var offsetRowCol={row:0,column:0},range=this._runtime.cellArrayToRange(cellsArray);if(range){var freeRange=this.getFreeRange(range.countRows(),range.countColumns());offsetRowCol.row=freeRange.getFirstRowCol().row-range.getFirstRowCol().row,offsetRowCol.column=freeRange.getFirstRowCol().column-range.getFirstRowCol().column,this.setCellsWithOffset(cellsArray,offsetRowCol)}return offsetRowCol},idr.workbook.Worksheet.prototype.setCellsWithOffset=function(cellsArray,offsetRowCol){for(var cells=[],i=0;i<cellsArray.length;i++){var name=this._runtime.calculateCellName(cellsArray[i].Name,offsetRowCol),copyCell=cellsArray[i],formulaText="",cellFormat=null,cellStyle=null;copyCell&&(formulaText=copyCell.FormulaText?this._runtime.calculateFormulaWithOffset(copyCell.FormulaText,offsetRowCol):"",cellFormat=copyCell.CellFormat,cellStyle=copyCell.CellStyle);var cell=this.setCell(name,formulaText);cell.loadCellFormatFromJson(cellFormat),cell.loadCellStyleFromJson(cellStyle),cells.push(cell)}return cells},idr.workbook.Worksheet.prototype.isEmpty=function(){return this._cells.isEmpty()};